services:
  # PostgreSQL 資料庫
  postgres:
    image: postgres:15-alpine
    container_name: opix_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: opix
      POSTGRES_PASSWORD: opix_password
      POSTGRES_DB: opix
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - opix_network

  # 後端服務
  server:
    image: node:20-alpine
    container_name: opix_server
    restart: unless-stopped
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    environment:
      DATABASE_URL: postgresql://opix:opix_password@postgres:5432/opix
      JWT_SECRET: your-development-jwt-secret-key-change-in-production
      NODE_ENV: development
      PORT: 3001
    ports:
      - "3001:3001"
    volumes:
      # Mount 整個 server 目錄，讓程式碼變更即時生效
      - ../server:/app
      # 使用 named volume 存放 node_modules，避免與本機衝突
      - server_node_modules:/app/node_modules
    depends_on:
      - postgres
    networks:
      - opix_network

  # 前端服務
  client:
    image: node:20-alpine
    container_name: opix_client
    restart: unless-stopped
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    ports:
      # 將容器的 5173 映射到本機的 8081
      - "8081:5173"
    volumes:
      # Mount 整個 client 目錄，讓程式碼變更即時生效
      - ../client:/app
      # 使用 named volume 存放 node_modules，避免與本機衝突
      - client_node_modules:/app/node_modules
    depends_on:
      - server
    networks:
      - opix_network

# 定義 volumes 用於資料持久化
volumes:
  postgres_data:
    name: opix_postgres_data
  server_node_modules:
    name: opix_server_node_modules
  client_node_modules:
    name: opix_client_node_modules

# 定義網路讓容器間可以互相通訊
networks:
  opix_network:
    name: opix_network
    driver: bridge
